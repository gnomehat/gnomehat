#!/usr/bin/env python3
import json
import os
import sys
import subprocess
import socket
import time
from gnomehat import sysinfo
from gnomehat import hostinfo

# The system consists of one server process (the GUI) and many workers
# One worker should be alive per GPU of any connected machine
def gnomehat_start(experiments_dir):
    # Check the server, restart it if needed
    if hostinfo.server_ok(experiments_dir):
        print('Host: Nothing to do, server is already running')
    else:
        run_server(experiments_dir)

    # HACK: kill and restart all the workers
    # TODO: proper daemonization, maybe supervisord, maybe upstart?
    print('Killing all workers...')
    os.system('pkill -f gnomehat_worker')
    print('All workers killed, ready to relaunch.')

    # For each GPU, generate a worker with CUDA_VISIBLE_DEVICES set
    gpus = sysinfo.get_gpu_info()
    for gpu_idx, gpu in enumerate(gpus):
        print('Starting worker for GPU {} ({})...'.format(gpu_idx, gpu['name']))
        run_worker(experiments_dir, gpu_idx)
        print('Started worker for GPU {}'.format(gpu_idx))
    print('All workers started')
    self_check(experiments_dir)


def self_check(experiments_dir):
    print('GnomeHat running self-check...')
    time.sleep(2)
    info = hostinfo.get_hostinfo(experiments_dir)
    print('GnomeHat UI is now running at:')
    print('\t{}'.format(info['gui_url']))


def run_worker(experiments_dir, gpu_idx):
    # HACK: nohup with output redirected instead of a proper daemon
    # Redirect stdout and stderr to a worker log file
    os.environ['CUDA_VISIBLE_DEVICES'] = str(gpu_idx)
    log_filename = '{}/worker_{}_{}.txt'.format(experiments_dir, socket.gethostname(), gpu_idx)
    cmd = 'nohup gnomehat_worker {} > {} 2>&1 &'.format(experiments_dir, log_filename)
    os.system(cmd)


def run_server(experiments_dir):
    print('Starting server at {}...'.format(experiments_dir))
    cmd = 'nohup gnomehat_server {0} > {0}/server.txt 2>&1 &'.format(experiments_dir)
    os.system(cmd)
    print('Server started at {}'.format(experiments_dir))


def gnomehat_stop():
    # TODO: Send a special signal maybe?
    os.system('pkill -f gnomehat_server')
    os.system('pkill -f gnomehat_worker')
    # TODO: Mark jobs as cancelled so they don't stay eternally 'still running'


def check_gpus():
    gpus = sysinfo.get_gpu_info()
    print('GnomeHat initializing...')
    print('Found {} GPUs:'.format(len(gpus)))
    for gpu in gpus:
        print('\t{}'.format(gpu['name']))


def gnomehat_restart_server(experiments_dir):
    os.system('pkill -f gnomehat_server')
    run_server(experiments_dir)


def load_config_file():
    config_path = os.path.expanduser('~/.gnomehat')
    try:
        cfg = json.loads(open(config_path).read())
        if 'experiments_dir' not in cfg:
            return False
    except:
        return False
    return cfg


def save_config_file(config):
    config_path = os.path.expanduser('~/.gnomehat')
    with open(config_path, 'w') as fp:
        fp.write(json.dumps(config, indent=2))


def get_experiments_dir():
    if len(sys.argv) == 3:
        experiments_dir = sys.argv[2]
    elif os.environ.get('GNOMEHAT_DIR'):
        experiments_dir = os.environ['GNOMEHAT_DIR']
    elif load_config_file():
        experiments_dir = load_config_file()['experiments_dir']
    else:
        print('\n')
        print('Hello!')
        print('It looks like this is your first time running gnomehat')
        print('(The GNOMEHAT_DIR variable has not been set.)')
        print('\n')
        print('Please choose a directory where your experiments should be stored.')
        print('Enter a directory name (eg. /home/username/experiments)')
        # TODO: readline
        experiments_dir = input('> ')
        print('\n')
        print('Now using {} as the GNOMEHAT_DIR'.format(experiments_dir))
        print('Saving {} to ~/.gnomehat'.format(experiments_dir))
        save_config_file({'experiments_dir': experiments_dir})
    print('Using experiments_dir: {}'.format(experiments_dir))
    os.makedirs(experiments_dir, exist_ok=True)
    return experiments_dir


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print('Usage:')
        print('\tgnomehat start [experiments_dir]')
        print('\tgnomehat stop')
        print('\tgnomehat status')
        print('\tgnomehat [-m message] <my_experiment.py> [--my-options ...]')
        exit(1)
    command = sys.argv[1]
    if command == 'start':
        check_gpus()
        experiments_dir = get_experiments_dir()
        gnomehat_start(experiments_dir)
    elif command == 'stop':
        print('Terminating all gnomehat processes...')
        gnomehat_stop()
    elif command == 'restart':
        print('Restarting...')
        experiments_dir = get_experiments_dir()
        gnomehat_stop()
        gnomehat_start(experiments_dir)
    elif command == 'status':
        print('The following gnomehat processes are running:')
        os.system('pgrep -a gnomehat')
    elif command == 'restart-server':
        experiments_dir = get_experiments_dir()
        gnomehat_restart_server(experiments_dir)
    else:
        # The command 'gnomehat train.py' is an alias for gnomehat_run
        subprocess.run(['gnomehat_run'] + sys.argv[1:])
